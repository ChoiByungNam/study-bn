<!DOCTYPE html>
<html lang="ko-KR">
<head>
	<meta charset="UTF-8">
	<title>Parallax</title>
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div id="skip-nav">
		<a href="#scene1" class="skip-nav-item"><span class="skip-nav-text">첫번째 컨텐츠 바로가기</span></a>
		<a href="#scene2" class="skip-nav-item"><span class="skip-nav-text">두번째 컨텐츠 바로가기</span></a>
		<a href="#scene3" class="skip-nav-item"><span class="skip-nav-text">세번째 컨텐츠 바로가기</span></a>
		<a href="#scene4" class="skip-nav-item"><span class="skip-nav-text">네번째 컨텐츠 바로가기</span></a>
		<a href="#scene5" class="skip-nav-item"><span class="skip-nav-text">다섯번째 컨텐츠 바로가기</span></a>
	</div>

	<div id="l-wrapper">

		<!--#include file="/C.Parallax/_include/header.html" -->

		<div id="l-content">
			<!-- Scene 1 -->
			<div id="scene1" class="scene" style="background-color: #f3f7fd;">
			</div>
			<!-- // Scene 1 -->

			<!-- Scene 2 -->
			<div id="scene2" class="scene" style="display: none;background-color: #e3f7fd;">Scene 2</div>
			<!-- // Scene 2 -->

			<!-- Scene 3 -->
			<div id="scene3" class="scene" style="display: none;background-color: #d3f7fd;">Scene 3</div>
			<!-- // Scene 3 -->

			<!-- Scene 4 -->
			<div id="scene4" class="scene" style="display: none;background-color: #c3f7fd;">Scene 4</div>
			<!-- // Scene 4 -->

			<!-- Scene 5 -->
			<div id="scene5" class="scene" style="display: none;background-color: #b3f7fd;">Scene 5</div>
			<!-- // Scene 5 -->
		</div>
	</div>

	<script src="https://code.jquery.com/jquery.min.js"></script>
	<script src="js/script.js"></script>
	<script type="text/javascript">
	//<![CDATA[
	$(function () {
		var PROPERTIES = ['translateX', 'translateY', 'opacity', 'rotate', 'scale'],
			$window = $(window),
			$body = $('body'),
			wrappers = [],
			currentWrapper = null,
			scrollTimeoutID = 0,
			bodyHeight = 0,
			windowHeight = 0,
			windowWidth = 0,
			prevKeyframesDurations = 0,
			scrollTop = 0,
			relativeScrollTop = 0,
			currentKeyframe = 0,
			keyframes = [
				{
					'wrapper': '#scene1',
					'duration': '100%',
					'animations': [
						{
							'selector': '.cube1',
							'translateY': ['0%', '70%'],
							'opacity': [0, 1]
						}, {
							'selector': '.cube2',
							'translateX': ['0%', '70%'],
							'opacity': [0, 1]
						}, {
							'selector': '.intro',
							'opacity': [0, 1]
						}
					]
				}, {
					'wrapper': '#scene2',
					'duration': '130%',
					'animations': []
				}, {
					'wrapper': '#scene3',
					'duration': '160%',
					'animations': []
				}, {
					'wrapper': '#scene4',
					'duration': '190%',
					'animations': []
				}, {
					'wrapper': '#scene5',
					'duration': '210%',
					'animations': []
				}
			];

		init = function () {
			scrollIntervalID = setInterval(updatePage, 10);
			setupValues();
			$window.resize(throwError)
			if (isTouchDevice) {
				$window.resize(throwError)
			}
		}

		setupValues = function () {
			scrollTop = $window.scrollTop();
			windowHeight = $window.height();
			windowWidth = $window.width();
			convertAllPropsToPx();
			buildPage();
		}

		buildPage = function () {
			var i, j, k;

			for (i = 0; i < keyframes.length; i++) {
				bodyHeight += keyframes[i].duration;
				if ($.inArray(keyframes[i].wrapper, wrappers) == -1) {
					wrappers.push(keyframes[i].wrapper);
				}
				for (j = 0; j < keyframes[i].animations.length; j++) {

					for (var key in keyframes[i].animations[j]) {
						[key].forEach(function (key) {
							value = keyframes[i].animations[j][key];
							if (key !== 'selector' && value instanceof Array === false) {
								var valueSet = [];
								valueSet.push(getDefaultPropertyValue(key), value);
								value = valueSet;
							}
							keyframes[i].animations[j][key] = value;
						});

						// if (typeof Array.prototype.forEach != 'function') {
						// 	Array.prototype.forEach = function(callback){
						// 		for (var i = 0; i < this.length; i++){
						// 			callback.apply(this, [this[i], i, this]);
						// 		}
						// 	};
						// }
					}
					// Object.keys(keyframes[i].animations[j]).forEach(function (key) {
					// 	value = keyframes[i].animations[j][key];
					// 	if (key !== 'selector' && value instanceof Array === false) {
					// 		var valueSet = [];
					// 		valueSet.push(getDefaultPropertyValue(key), value);
					// 		value = valueSet;
					// 	}
					// 	keyframes[i].animations[j][key] = value;
					// });
					// console.log(Object.keys(keyframes[i].animations[j]));
					// for (var key in keyframes[i].animations[j]) {
					// 	console.log([key]);
					// }

				}
			}
			$body.height(bodyHeight);
			$window.scroll(0);
			currentWrapper = wrappers[0];
			$(currentWrapper).show();
		}

		convertAllPropsToPx = function () {
			var i, j, k;

			for (i = 0; i < keyframes.length; i++) {
				keyframes[i].duration = convertPercentToPx(keyframes[i].duration, 'y');
				for (j = 0; j < keyframes[i].animations.length; j++) {

					for (var key in keyframes[i].animations[j]) {
						[key].forEach(function (key) {
							value = keyframes[i].animations[j][key];
							if (key !== 'selector') {
								if (value instanceof Array) {
									for (k = 0; k < value.length; k++) {
										if (typeof value[k] === 'string') {
											if (key === 'translateY') {
												value[k] = convertPercentToPx(value[k], 'y');
											} else {
												value[k] = convertPercentToPx(value[k], 'x');
											}
										}
									}
								} else {
									if (typeof value === 'string') {
										if (key === 'translateY') {
											value = convertPercentToPx(value[k], 'y');
										} else {
											value = convertPercentToPx(value[k], 'x');
										}
									}
								}
								keyframes[i].animations[j][key] = value;
							}
						});

						for (var l = 0, len = [key].length; l < len; l++) {
							console.log([key]);
						}
					}

					// Object.keys(keyframes[i].animations[j]).forEach(function (key) {
					// 	value = keyframes[i].animations[j][key];
					// 	if (key !== 'selector') {
					// 		if (value instanceof Array) {
					// 			for (k = 0; k < value.length; k++) {
					// 				if (typeof value[k] === 'string') {
					// 					if (key === 'translateY') {
					// 						value[k] = convertPercentToPx(value[k], 'y');
					// 					} else {
					// 						value[k] = convertPercentToPx(value[k], 'x');
					// 					}
					// 				}
					// 			}
					// 		} else {
					// 			if (typeof value === 'string') {
					// 				if (key === 'translateY') {
					// 					value = convertPercentToPx(value[k], 'y');
					// 				} else {
					// 					value = convertPercentToPx(value[k], 'x');
					// 				}
					// 			}
					// 		}
					// 		keyframes[i].animations[j][key] = value;
					// 	}
					// });


				}
			}
		}

		getDefaultPropertyValue = function (property) {
			switch (property) {
				case 'translateX':
					return 0;
				case 'translateY':
					return 0;
				case 'scale':
					return 1;
				case 'rotate':
					return 0;
				case 'opacity':
					return 1;
				default:
					return null;
			}
		}

		updatePage = function () {
			window.requestAFrame = (function () {
				return window.requestAnimationFrame ||
				window.webkitRequestAnimationFrame ||
				window.mozRequestAnimationFrame ||
				window.oRequestAnimationFrame ||
				function (callback) {
					return window.setTimeout(callback, 1000 / 60);
				};
			})();

			requestAFrame(function () {
				setScrollTops();
				if (scrollTop > 0 && scrollTop <= (bodyHeight - windowHeight)) {
					animateElements();
					setKeyframe();
				}
			});
		}

		setScrollTops = function () {
			scrollTop = $window.scrollTop();
			relativeScrollTop = scrollTop - prevKeyframesDurations;
		}

		animateElements = function () {
			var animation, translateY, translateX, scale, rotate, opacity;
			for (var i = 0; i < keyframes[currentKeyframe].animations.length; i++) {
				animation = keyframes[currentKeyframe].animations[i];
				translateY = calcPropValue(animation, 'translateY');
				translateX = calcPropValue(animation, 'translateX');
				scale = calcPropValue(animation, 'scale');
				rotate = calcPropValue(animation, 'rotate');
				opacity = calcPropValue(animation, 'opacity');

				$(animation.selector).css({
					'transform': 'translate3d(' + translateX +'px, ' + translateY + 'px, 0) scale('+ scale +') rotate('+ rotate +'deg)',
					'opacity': opacity
				})
			}
		}

		calcPropValue = function (animation, property) {
			var value = animation[property];
			if (value) {
				value = easeInOutQuad(relativeScrollTop, value[0], (value[1]-value[0]), keyframes[currentKeyframe].duration);
			} else {
				value = getDefaultPropertyValue(property);
			}
			return value;
		}

		easeInOutQuad = function (t, b, c, d) {
			return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
		}

		setKeyframe = function () {
			if (scrollTop > (keyframes[currentKeyframe].duration + prevKeyframesDurations)) {
				prevKeyframesDurations += keyframes[currentKeyframe].duration;
				currentKeyframe++;
				showCurrentWrappers();
			} else if (scrollTop < prevKeyframesDurations) {
				currentKeyframe--;
				prevKeyframesDurations -= keyframes[currentKeyframe].duration;
				showCurrentWrappers();
			}
		}

		showCurrentWrappers = function () {
			var i;

			if (keyframes[currentKeyframe].wrapper != currentWrapper) {
				$(currentWrapper).hide();
				$(keyframes[currentKeyframe].wrapper).show();
				currentWrapper = keyframes[currentKeyframe].wrapper;
			}
		}

		convertPercentToPx = function (value, axis) {
			if (typeof value === "string" && value.match(/%/g)) {
				if (axis === 'y') value = (parseFloat(value) / 100) * windowHeight;
				if (axis === 'x') value = (parseFloat(value) / 100) * windowWidth;
			}
			return value;
		}

		throwError = function () {
			$body.addClass('page-error')
		}

		isTouchDevice = function () {
			return 'ontouchstart' in window || 'onmsgesturechange' in window;
		}

		init();
	});
	//]]>
	</script>
</body>
</html>
